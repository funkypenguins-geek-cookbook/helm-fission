---
# Source: fission-all/templates/router.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: router
  labels:
    chart: "fission-all-1.8.1-pre16"
    svc: router
    application: fission-router
spec:
  replicas: 1
  selector:
    matchLabels:
      application: fission-router
      svc: router
  template:
    metadata:
      labels:
        application: fission-router
        svc: router
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/path: "/metrics"
        prometheus.io/port: "8080"
    spec:
      securityContext:
                  {}     
      containers:
      - name: router
        image: "index.docker.io/fission/fission-bundle:1.8.0"
        imagePullPolicy: IfNotPresent
        command: ["/fission-bundle"]
        args: ["--routerPort", "8888", "--executorUrl", "http://executor.default"]
        env:
          - name: POD_NAMESPACE
            valueFrom:
              fieldRef:
                fieldPath: metadata.namespace
          - name: ROUTER_ROUND_TRIP_TIMEOUT
            value: "50ms"
          - name: ROUTER_ROUNDTRIP_TIMEOUT_EXPONENT
            value: "2"
          - name: ROUTER_ROUND_TRIP_KEEP_ALIVE_TIME
            value: "30s"
          - name: ROUTER_ROUND_TRIP_DISABLE_KEEP_ALIVE
            value: "true"
          - name: ROUTER_ROUND_TRIP_MAX_RETRIES
            value: "10"
          - name: ROUTER_SVC_ADDRESS_MAX_RETRIES
            value: "5"
          - name: ROUTER_SVC_ADDRESS_UPDATE_TIMEOUT
            value: "30s"
          - name: TRACE_JAEGER_COLLECTOR_ENDPOINT
            value: ""
          - name: TRACING_SAMPLING_RATE
            value: "0.5"
          - name: USE_ENCODED_PATH
            value: "false"
          - name: DEBUG_ENV
            value: "false"
          - name: DISPLAY_ACCESS_LOG
            value: "false"
          - name: ANALYTICS_URL
            value: "https://g.fission.io/metrics"
        readinessProbe:
          httpGet:
            path: "/router-healthz"
            port: 8888
          initialDelaySeconds: 1
          periodSeconds: 1
          failureThreshold: 30
        livenessProbe:
          httpGet:
            path: "/router-healthz"
            port: 8888
          initialDelaySeconds: 35
          periodSeconds: 5
        ports:
        - containerPort: 8080
          name: metrics
        - containerPort: 8888
          name: http
      securityContext:
              {}           
      serviceAccountName: fission-svc
      resources:
            {}
